<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Altona Village Community Management System</title>
  </head>
  <body>
    <div id="root"></div>

    <!-- Global auth shims:
         - Read token from storage (no async)
         - Fix any bad 'Authorization: Bearer undefined'
         - Attach Authorization to ALL backend API calls (fetch + axios/XHR) -->
    <script>
      (function () {
        const API = 'https://altona-village-backend.onrender.com';

        function getToken() {
          const keys = ['access_token','token','jwt','key','authToken'];
          for (const k of keys) {
            const v = localStorage.getItem(k) || sessionStorage.getItem(k);
            if (typeof v === 'string' && v && v !== 'undefined') return v.replace(/^Bearer\s+/i, '');
          }
          // cookies as a fallback
          const parts = document.cookie.split('; ').filter(Boolean);
          for (const p of parts) {
            const i = p.indexOf('=');
            const val = decodeURIComponent(p.slice(i + 1));
            if (val && val !== 'undefined') return val.replace(/^Bearer\s+/i, '');
          }
          return null;
        }

        // ---------- FETCH SHIM ----------
        const origFetch = window.fetch;
        window.fetch = function (input, init) {
          const url = typeof input === 'string' ? input : (input && input.url) || '';
          const needsAuth = url && (url.startsWith(API + '/api/') || url.startsWith('/api/'));

          if (needsAuth) {
            init = init || {};
            const headers = new Headers(init.headers || {});
            let auth = headers.get('Authorization');

            // if header missing, malformed, or contains 'undefined', fix it
            const token = getToken();
            if (!auth || /undefined/i.test(String(auth)) || !/^Bearer\s.+/.test(String(auth))) {
              if (token) headers.set('Authorization', 'Bearer ' + token);
            }
            init.headers = headers;
          }

          return origFetch(input, init);
        };

        // ---------- XHR/AXIOS SHIM ----------
        const XHR = XMLHttpRequest.prototype;
        const _open = XHR.open;
        const _send = XHR.send;
        const _setHeader = XHR.setRequestHeader;

        XHR.open = function (method, url) {
          this.__url = String(url || '');
          this.__hdrs = {};
          return _open.apply(this, arguments);
        };

        XHR.setRequestHeader = function (name, value) {
          try {
            const lname = String(name).toLowerCase();
            this.__hdrs[lname] = value;
            // If app tries to set 'Bearer undefined', replace it right here
            if (lname === 'authorization') {
              const token = getToken();
              if (token) value = 'Bearer ' + token;
            }
          } catch {}
          return _setHeader.call(this, name, value);
        };

        XHR.send = function (body) {
          try {
            const url = this.__url || '';
            const needsAuth = url.startsWith(API + '/api/') || url.startsWith('/api/');
            const hasAuth = this.__hdrs && typeof this.__hdrs['authorization'] !== 'undefined';

            if (needsAuth) {
              const token = getToken();
              if (token) {
                if (!hasAuth || /undefined/i.test(String(this.__hdrs['authorization']))) {
                  _setHeader.call(this, 'Authorization', 'Bearer ' + token);
                }
              }
            }
          } catch {}
          return _send.apply(this, arguments);
        };
      })();
    </script>

    <!-- App bundle (keep after shims) -->
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
